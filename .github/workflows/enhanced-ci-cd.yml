name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Frontend Testing
  frontend-tests:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'src/frontend/') || github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: src/frontend/package-lock.json
    
    - name: Install frontend dependencies
      run: |
        cd src/frontend
        npm ci
    
    - name: Run frontend linting
      run: |
        cd src/frontend
        npm run lint
    
    - name: Run frontend tests
      run: |
        cd src/frontend
        npm test -- --coverage --watchAll=false
    
    - name: Build frontend
      run: |
        cd src/frontend
        npm run build

  # Backend Testing
  backend-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run code formatting check
      run: |
        black --check src/
        isort --check-only src/
    
    - name: Run linting
      run: |
        flake8 src/
        pylint src/
    
    - name: Run type checking
      run: |
        mypy src/
    
    - name: Run unit tests
      run: |
        pytest tests/unit/ --cov=src/ --cov-report=xml --cov-report=html
    
    - name: Run integration tests
      run: |
        pytest tests/integration/ -v
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        fail_ci_if_error: true

  # Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install security scanning tools
      run: |
        pip install bandit safety semgrep
    
    - name: Run Bandit security scan
      run: |
        bandit -r src/ -f json -o bandit-report.json
        bandit -r src/ # Also show in console
    
    - name: Run Safety dependency scan
      run: |
        safety check --json --output safety-report.json
        safety check # Also show in console
    
    - name: Run Semgrep scan
      run: |
        semgrep --config=auto src/ --json --output=semgrep-report.json
    
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          semgrep-report.json

  # Agent-Specific Testing
  agent-tests:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'src/agents/') || github.event_name == 'pull_request'
    
    strategy:
      matrix:
        agent-team: [web_app_team, api_security_team, static_analysis_team, infrastructure_team, reporting_team]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Test ${{ matrix.agent-team }} agents
      run: |
        pytest tests/agents/${{ matrix.agent-team }}/ -v --cov=src/agents/${{ matrix.agent-team }}/
    
    - name: Performance test agents
      run: |
        python scripts/test_agent_performance.py ${{ matrix.agent-team }}
    
    - name: Security scan agents
      run: |
        bandit -r src/agents/${{ matrix.agent-team }}/

  # Docker Build and Test
  docker-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build development image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.dev
        push: false
        tags: ryha-ai:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker container
      run: |
        docker run --rm ryha-ai:test python -c "import src; print('Import successful')"
        docker run --rm ryha-ai:test pytest tests/unit/ --maxfail=1

  # Infrastructure as Code Testing
  infrastructure-tests:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.modified, 'infrastructure/') || github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.0
    
    - name: Terraform Format Check
      run: |
        cd infrastructure/terraform
        terraform fmt -check
    
    - name: Terraform Init
      run: |
        cd infrastructure/terraform
        terraform init
    
    - name: Terraform Validate
      run: |
        cd infrastructure/terraform
        terraform validate
    
    - name: Terraform Plan
      run: |
        cd infrastructure/terraform
        terraform plan -input=false

  # End-to-End Tests (only on main branch)
  e2e-tests:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [frontend-tests, backend-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        cd src/frontend && npm ci
    
    - name: Start services
      run: |
        docker-compose up -d
        sleep 30 # Wait for services to be ready
    
    - name: Run E2E tests
      run: |
        pytest tests/e2e/ -v
    
    - name: Stop services
      if: always()
      run: |
        docker-compose down

  # Build and Deploy (only on main branch)
  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests, security-scan, docker-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Container Registry
      uses: docker/login-action@v3
      with:
        registry: gcr.io
        username: _json_key
        password: ${{ secrets.GCP_SA_KEY }}
    
    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          gcr.io/${{ secrets.GCP_PROJECT_ID }}/ryha-ai-backend:latest
          gcr.io/${{ secrets.GCP_PROJECT_ID }}/ryha-ai-backend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: ./src/frontend
        file: ./src/frontend/Dockerfile
        push: true
        tags: |
          gcr.io/${{ secrets.GCP_PROJECT_ID }}/ryha-ai-frontend:latest
          gcr.io/${{ secrets.GCP_PROJECT_ID }}/ryha-ai-frontend:${{ github.sha }}
    
    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # Add deployment commands here
    
    - name: Run smoke tests
      run: |
        echo "Running post-deployment smoke tests..."
        # Add smoke tests here

  # Notification
  notify:
    runs-on: ubuntu-latest
    needs: [build-and-deploy]
    if: always()
    
    steps:
    - name: Notify team
      if: failure()
      run: |
        echo "Pipeline failed - would send notifications here"
        # Add Slack/Discord notification logic